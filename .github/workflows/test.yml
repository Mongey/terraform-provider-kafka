name: test

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.x
      - run: make test

  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: 1.22.x
      - uses: actions/checkout@v4
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          args: --timeout=3m

  acctest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.x
      - uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Create secrets directory
        run: mkdir -p secrets
      - name: Generate test certificates
        run: |
          # Generate CA key and certificate
          openssl genrsa -out secrets/ca.key 2048
          openssl req -new -x509 -key secrets/ca.key -out secrets/ca.crt -days 365 -subj "/CN=ca"
          
          # Generate client key and certificate
          openssl genrsa -out secrets/client.key 2048
          openssl req -new -key secrets/client.key -out secrets/client.csr -subj "/CN=client"
          openssl x509 -req -in secrets/client.csr -CA secrets/ca.crt -CAkey secrets/ca.key -CAcreateserial -out secrets/client.crt -days 365
          
          # Create PEM file
          cat secrets/client.crt secrets/client.key > secrets/client.pem
          
          # Create terraform-cert.pem (copy of client.pem for test compatibility)
          cp secrets/client.pem secrets/terraform-cert.pem
          cp secrets/client.pem secrets/terraform.pem
      - name: Bring up kafka + zk
        run: docker compose up -d
      - name: Wait for Kafka to be ready
        run: |
          echo "Waiting for Kafka to be ready..."
          timeout 60s bash -c 'until docker exec $(docker ps -q --filter "name=kafka") kafka-topics.sh --bootstrap-server localhost:9092 --list; do sleep 2; done'
          echo "Kafka is ready!"
      - name: "Run tests"
        run: |
          export TF_ACC=1
          export KAFKA_BOOTSTRAP_SERVERS=localhost:9092
          export KAFKA_SKIP_VERIFY=true
          make testacc
